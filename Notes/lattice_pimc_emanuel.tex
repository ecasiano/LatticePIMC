%\title{Lattice Path Integral Monte Carlo}
%\author{Emanuel Casiano-Diaz}
%\date{September 6, 2019.}

%Formatting Packages
\documentclass[12pt, two sided]{article}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,top=1.1in,bottom=1.1in,left=1.6in,right=1.1in]{geometry}

%Math Packages
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\DeclareMathOperator{\Tr}{Tr}

%Physics Package
\usepackage{physics}

%Allow accentuation marks
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

%Image packages
\usepackage{graphicx}
\graphicspath{ {Images/} }

%Enumerating lists
\usepackage{enumerate}% http://ctan.org/pkg/enumerate

%Adjust depth of subsections
\setcounter{secnumdepth}{3}

%Adjust depth of table of contents
\setcounter{tocdepth}{3}

%References Packages
%\usepackage{biblatex}
%\addbibresource{references.bib}
\usepackage[bookmarks=true]{hyperref}
\hypersetup{
    hidelinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

%Commands and packages imported from particle entanglement paper
\usepackage{amsmath}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{amssymb}

\newcommand{\eket}[1]{\bigl \vert #1 \bigr \rangle}
\newcommand{\R}{\boldsymbol{R}}
\newcommand{\Rt}{\tilde{\R}}
\newcommand{\ebra}[1]{\bigl \langle #1 \bigr \vert}
\newcommand{\eexp}[1]{\bigl \langle #1 \bigr \rangle}
\newcommand{\figref}[1]{Fig.~\ref{#1}}
\renewcommand{\vec}[1]{\boldsymbol{#1}}
\newcommand{\ren}{R\'{e}nyi~}
\newcommand{\rnote}[1]{{\it \textcolor{red}{#1} }}
\newcommand{\Eqref}[1]{Eq.~\eqref{#1}}

%Copied from paper
\usepackage{color}
\usepackage{graphicx}
\usepackage[color=green!60]{todonotes}
\usepackage{physics}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumerate}
\usepackage{placeins}
\usepackage{booktabs}
\usepackage{dsfont}

%For reference formatting
\usepackage[numbers,sort&compress]{natbib}
\bibliographystyle{nsf_new_url}

\setlength{\footskip}{22pt}
 
 %Line spacing
\usepackage{setspace}
\doublespace

% --------- Begin Document -------- %
\begin{document}

\section{Partition function}

\begin{equation}
\ket{\psi_0} = \lim_{\beta\to\infty} e^{-\frac{\beta}{2} H} \ket{\psi_T}
\end{equation}

\begin{equation}
\mathcal{Z}_0 = \bra{\psi_0} \hat{I} \ket{\psi_0} = \lim_{\beta\to\infty} \bra{\psi_T} e^{-\beta H} \ket{\psi_T}
\end{equation}

\begin{equation}
\label{eq:Z_0}
\mathcal{Z}_0 \approx \sum_{\alpha_0} \vert C_{\alpha_0} \vert^2 e^{-\epsilon_{\alpha_0} \beta} + \\
\sum_{Q=1}^{\infty} \sum_{\alpha_0, \alpha_1 \dots \alpha_Q} (\prod_{q=1}^Q \int_0^{\tau_{q-1}} d\tau_q e^{-\epsilon_{\alpha_{q-1}}(\tau_{q-1}-\tau_q)} 
\bra{\alpha_{q-1}} H_1 \ket{\alpha_q}) C_{\alpha_0} C_{\alpha_Q}^* e^{-\epsilon_{\alpha_Q} \tau_Q}
\end{equation}
\section{Metropolis sampling}

In this section, a brief walkthrough of the Metropolis-Hastings algorithm \cite{doi:10.1063/1.1699114} will be given. First, the process of obtaining acceptance ratios that satisfy the Principle of Detailed Balance will be given. Then, the Metropolis-Hastings algorithm will be stated.

\subsection{Deriving Metropolis acceptance ratios}

The Principle of Detailed Balance states that in an equilibrium system, the number of transitions from a configuration $x$ to a configuration $x'$, must be equal to the number of transitions from $x'$ to $x$. This principle can be expressed as:
%
\begin{equation}
\label{eq:detailed_balance_principle}
p(x)P(x \to x') = p(x') P(x' \to x)
\end{equation}
%
where $p(x)$ is the steady state probability distribution, and $P(x \to x')$ is the probability of transitioning to $x'$ conditional to original state $x$. Solving for the ratio of transition probabilities:
%
\begin{equation}
\label{eq:transition_ratio}
\frac{P(x \to x')}{P(x' \to x)} = \frac{p(x')}{p(x)} 
\end{equation}
%
The transition probability can rewritten as a factor of proposal and acceptance probabilities:
%
\begin{equation}
P(x \to x') = g(x \to x') A(x \to x')
\end{equation}
%
where $g(x \to x')$ is the probability of proposing an update that takes the state of the system from $x$ to $x'$, and $A(x \to x')$ is the probability of accepting such update. Substituting the factored transition probabilities into Eq.~\eqref{eq:transition_ratio}:
%
\begin{equation}
\frac{g(x \to x') A(x \to x')}{ g(x' \to x) A(x' \to x)} = \frac{p(x')}{p(x)} 
\end{equation}
%
The ratio of acceptance probabilities becomes:
%
\begin{equation}
\label{eq:acceptance_ratio}
\frac{A(x \to x')}{A(x' \to x)} = \frac{p(x')g(x' \to x)}{p(x) g(x \to x')} \equiv R
\end{equation}
%
Depending on the value of $R$, there are various ways in which the acceptance probabilities can be chosen, such that they satisfy Eq.~\eqref{eq:acceptance_ratio}.

If $R \leq 1$:
%
\begin{equation} 
A(x \to x' ) = R \text{ and } A(x' \to x) = 1 \nonumber
\end{equation}
%

If $R > 1$: 
\begin{equation}
A(x \to x' ) = 1 \text{ and } A(x' \to x) = 1/R \nonumber
\end{equation}

The above selections can be summarized as:
%
\begin{equation}
\label{eq:general_acceptance_probs}
A(x \to x') = min\{1,R\} \text{ and } A(x' \to x) = min\{1,1/R\}
\end{equation}
%

As part of Metropolis sampling, proposed configurations will be accepted with the probabilities in Eq.~\eqref{eq:general_acceptance_probs}.

\subsection{The Metropolis-Hastings algorithm}


\begin{equation}
\label{eq:sexytime}
\pi \approx 3.14\dots
\end{equation}

Essentialy, Eq.~\eqref{eq:sexytime} is an approximation. In the incredible paper by Prokokkokokok \cite{Prokof_ev_1998}, the authors play some Pokemon. In the Metropolis paper \cite{doi:10.1063/1.1699114}. On the Brian Keng's website \cite{bkeng.metropolis}

\section{Lattice Worm Algorithm (WA) Updates}

In this section, a set of ergodic lattice worm updates is introduced. First, an explanation of how each update changes the system is given.. Then, a walkthrough of the decisions that comprise each update will be given, including the probabilities for each desicion's outcome. Finally, the Metropolis conditions are derived or the direct sampling explained, depending on the update.

	\subsection{Insert/Delete worm}
        
    The insert worm update creates a particle on a flat region of a worldline, then destroys it after a certain time, also inside the same flat region. Formally, the particle is created by acting on the state at that imaginary time with the bosonic creation operator (worm tail) and anihilated by acting with the bosonic anihilation operator (worm head). An antiworm can instead be inserted by first inserting the worm head and then the tail. In other words, an antiworm will first anihilate a particle and create one at a later time inside the flat region. The update proceeds as follows:
%
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{iw}$ {\color{red} What is this actually? There's already an attempt and acceptance prob.}
        \item Randomly choose an integer $i \in [0,L-1]$, where $L$ is the number of sites on the lattice. The $i^{th}$ site will be chosen wih probability $p_i = 1/L$.
        \item Randomly choose an integer $f \in [0,F - 1]$, where $F$ is the number of flat regions on site $i$. The $f^{th}$ flat region will be chosen with probability $p_{f} = 1/F$
        \item Count the number of particles $n_{flat}$ on the flat region and check if inserting an antiworm is possible:
            \begin{enumerate}
            \item If $n_{flat} = 0$ : Only a worm can be inserted with probability $p_{type} = 1$
            \item Else: A worm or antiworm can be inserted with probability $p_{type} = 1/2$
            \end{enumerate}
        \item Randomly choose a real number $\Delta\tau_{worm} = rand()*\Delta\tau_{flat}$, where $\Delta\tau_{flat}$ is the length of the flat region and $rand()$ is a random number from the uniform distribution in the interval $[0,1)$. The probability of the worm being of length $\Delta\tau_{worm}$ is $p_{len} = 1/{\Delta\tau_{flat}}$
        \item Randomly select a real number $\tau = \tau_{min} + rand()*(\Delta\tau_{flat}-\Delta\tau_{worm})$, where $\tau_{min}$ is the lower bound of the flat region. The probability of inserting the worm (antiworm) tail (head) at $\tau$ is $p_{\tau} = 1/(\Delta\tau_{flat} - \Delta\tau_{worm})$.
        \item Calculate the ratio of weights of configurations pre and post worm insertion:
            %
            \begin{equation}
            \frac{W_+}{W_-} = \eta^2 e^{-\Delta\tau_{worm} \Delta V}
            \label{eq:insert_ratios}
            \end{equation}
            %
            where $W_+$ and $W_-$ are the weights of the configuration with a worm and no worm, respectively, $\eta$ is the worm fugacity and $\Delta V$ is the change in potential energy pre and post worm insertion. 
    \end{enumerate}
    %
    {\color{red}-Derive $\Delta V$ here for insert worm and antiworm} \\ 
    {\color{red}-Give a similar walkthrough of the delete worm update} \\
    {\color{red}-Derive the Metropolis condition from Detailed Balance} \\
%
    %
    \begin{equation}
    \pi \approx 3.14159...
    \label{eq:detailed_balance}
    \end{equation}
    %

    \subsection{Insert/Delete ground state (gs) worm}
    These updates will be very similar to the insert/delete worm update. The main difference is that these are particular to the case of zero temperature. Remember that at zero temperature, imaginary time is not subject to periodic boundary conditions, as is the case at finite temperature. Instead, open boundary conditions are imposed in the imaginary time direction, while keeping the space direction periodic. 

    The open boundary conditions will allow now for the insertion of worms that will have one of its ends go past either the $\tau = 0$ or the $\tau = \beta$ boundaries. These worms that go past the imaginary time boundaries will be called ground state (gs) worms. In practice, inserting a gs-worm will look like inserting only one worm end to the worldline configuration at a time, and analogously for deletion. 

    \subsubsection{Insert gs-worm}

    At $T=0$, a ground state (gs) worm or antiworm can be inserted. One of the ends of this worm will lie either past the $\tau=0$ or the $\tau=\beta$ boundaries. The other end, will lie in the flat region preceding this boundary (i.e, the first or the last flat region). In practice, this will look like inserting a single worm end to the worldline configuration at these flat regions. This worm end can only be inserted if there are no worm ends or one worm end present. The update proceeds as
    follows:
    % Insert gs-worm %
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{gsiw}$
    \item Choose site with probability $p=1/L$
    \item Choose first or last flat:
        \begin{enumerate}
            \item if $n_{flats} = 1$: treat the flat as first or last (depending on the implementation) with $p=1$
            \item else: $p=1/2$
        \end{enumerate}
    \item Choose gs-worm or gs-antiworm:
        if $n_i=0$: can only insert worm with prob. $p=1$ 
        else: choose either with $p=1/2$
    \item Choose the insertion time of the worm end $\tau = \tau_{min} + rand() (\tau_{max}-\tau_{min})$ with probability $p=1/(\tau_{max}-\tau_{min})$
    \end{enumerate}

    \subsubsection{Delete gs-worm}
    The Delete gs-worm update can only be done if there's at least one worm end on the worldline configuration. A random worm end is chosen and then deleted. The update proceeds as follows:
    % Delete gs-worm %
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{gsdw}$
    \item Choose the worm end to be deleted with probability $p=1/2$
    \end{enumerate}

    \subsubsection{Acceptance probabilities of gs-worm insert/delete}

    From detailed balance:
    %
    \begin{equation}
        w_- p_{gsiw}^{att} p_{gsiw}^{acc} = W_+ p_{gsdw}^{att} p_{gsdw}^{acc}
    \end{equation}
    %

    Solving for the ratio of acceptance probabilities:
    %
    \begin{equation}
        \frac{p_{gsiw}^{acc}}{p_{gsdw}^{acc}} = \frac{p_{gsdw}^{att} W_+}{p_{gsiw}^{att} W_-}  
    \end{equation}
    %

    Inserting the attempt probabilities:
    %
    \begin{equation}
        \frac{p_{gsiw}^{att}}{p_{gsdw}^{att}} = \frac{p_{gsdw}^{att}}{p_{gsiw}^{att}} \frac{L(\tau_{max}-\tau_{min})}{p_{flat}} \frac{W_+}{W-}
    \end{equation}
    %

    where $p_{flat}$ is the probability of choosing either the first or last flat region of the worldline. If there are no kinks in the worldline, $p_{flat}=1$, and if there are kinks, $p_{flat=1/2}$.


    The ratio of weights for configurations after a gs-worm insertion and after it is deleted is:
    %
    \begin{equation}
        \frac{W_+}{W_-} = \eta e^{-\Delta \tau \Delta V}
    \end{equation}
    %

	\subsection{Timeshift}
    \subsubsection{Forward}
    The timeshift update consists of moving either a worm head or tail either forward or backwards in imaginary time. The update proceeds as follow:
    % Timeshift forward
    \begin{enumerate}
        \setcounter{enumi}{-1}
        \item Do with probability $p_{fw}$ :
        \item Choose which worm end will move, head or tail, with probability $p = 1/2$
        \item Randomly choose a real number $\tau_{new} = \tau + rand()*(\tau_{max}-\tau)$, where $\tau_{max}$ is the upper bound of the flat region delimited by the moving end and the next kink or worm end and $\tau$ is the original time of the moving worm end. The probability that the worm end will move to this time is $p = 1/(\tau_{max}-\tau)$
        \item Calculate the ratio of weights of configurations pre and post timeshifting forward:
            %
            \begin{equation}
            \frac{W_+}{W_-} = e^{-\Delta\tau_{worm} \Delta V} = 1
            \label{eq:forward_ratios}
            \end{equation}
            %
            where $W_+$ and $W_-$ are the weights of the configuration post and pre moving forward, respectively, and $\Delta V$ is the change in potential energy. Since the number of particles on each site remains constant before and after the update, the change in potential energy is $dV = 0$ and thus the exponential becomes unity.

    \end{enumerate}
    %
    \subsubsection{Backward}
    % Timeshift backward
    \begin{enumerate}
        \setcounter{enumi}{-1}
        \item Do with probability $p_{bw}$ :
        \item Choose which worm end will move, head or tail, with probability $p = 1/2$
        \item Randomly choose a real number $\tau_{new} = \tau_{min} + rand()*(\tau-\tau_{min})$, where $\tau_{min}$ is the lower bound of the flat region delimited by the moving end and the preceding kink or worm end and $\tau$ is the original time of the moving worm end. The probability that the worm end will move to this time is $p = 1/(\tau-\tau_{min})$
        \item Calculate the ratio of weights of configurations pre and post timeshifting backward:
            %
            \begin{equation}
            \frac{W_-}{W_+} = e^{\Delta\tau_{worm} \Delta V} = 1
            \label{eq:tsbw_ratios}
            \end{equation}
            %
    \end{enumerate}

    % Detailed balance of timeshift
    \subsubsection{Detailed balance}
    %
    \begin{equation}
    p_{fw}^{att} p_{fw}^{acc} W_- = p_{fw}^{att} p_{fw}^{acc} W_+
    \end{equation}
    %
    The attempt probabilities for the forward and backward timeshift can be read off from the description of the update. Substituting them in and solving for $p_{fw}^{acc}/p_{bw}^{acc}$:
    %
    \begin{equation}
    \frac{p_{fw}^{acc}}{p_{bw}^{acc}} = \frac{\tau_{max}-\tau}{\tau-\tau_{min}} = R
    \end{equation}
    %

	\subsection{Spaceshift before}
	\subsection{Spaceshift after}
	
% References
\phantomsection 
\addcontentsline{toc}{chapter}{References} 
%\bibliographystyle{apalike} %acm, ieetr, apalike...
 %\section*{Referencess
 \singlespacing
\bibliography{references}

\doublespacing

\end{document}
