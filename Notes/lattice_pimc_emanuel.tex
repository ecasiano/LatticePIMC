%\title{Lattice Path Integral Monte Carlo}
%\author{Emanuel Casiano-Diaz}
%\date{September 6, 2019.}

%Formatting Packages
\documentclass[12pt, two sided]{article}
\usepackage[utf8]{inputenc}
%\usepackage[letter,top=1.1in,bottom=1.1in,left=1.6in,right=1.1in]{geometry}
\usepackage[letterpaper,margin=1in]{geometry}


%Math Packages
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\DeclareMathOperator{\Tr}{Tr}

%Physics Package
\usepackage{physics}

%Allow accentuation marks
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

%Image packages
\usepackage{graphicx}
\graphicspath{ {Images/} }

%Enumerating lists
\usepackage{enumerate}% http://ctan.org/pkg/enumerate

%Adjust depth of subsections
\setcounter{secnumdepth}{3}

%Adjust depth of table of contents
\setcounter{tocdepth}{3}

%References Packages
%\usepackage{biblatex}
%\addbibresource{references.bib}
\usepackage[bookmarks=true]{hyperref}
\hypersetup{
    hidelinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

%Commands and packages imported from particle entanglement paper
\usepackage{amsmath}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{amssymb}

\newcommand{\eket}[1]{\bigl \vert #1 \bigr \rangle}
\newcommand{\R}{\boldsymbol{R}}
\newcommand{\Rt}{\tilde{\R}}
\newcommand{\ebra}[1]{\bigl \langle #1 \bigr \vert}
\newcommand{\eexp}[1]{\bigl \langle #1 \bigr \rangle}
\newcommand{\figref}[1]{Fig.~\ref{#1}}
\renewcommand{\vec}[1]{\boldsymbol{#1}}
\newcommand{\ren}{R\'{e}nyi~}
\newcommand{\rnote}[1]{{\it \textcolor{red}{#1} }}
\newcommand{\Eqref}[1]{Eq.~\eqref{#1}}

%Copied from paper
\usepackage{color}
\usepackage{graphicx}
\usepackage[color=green!60]{todonotes}
\usepackage{physics}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumerate}
\usepackage{placeins}
\usepackage{booktabs}
\usepackage{dsfont}

%For reference formatting
\usepackage[numbers,sort&compress]{natbib}
\bibliographystyle{nsf_new_url}

\setlength{\footskip}{22pt}

 %Line spacing
\usepackage{setspace}
\doublespace

% --------- Begin Document -------- %
\begin{document}

%----- Bose Hubbard Model -------%


\section{The Bose-Hubbard Model}

The Bose-Hubbard (BH) model describes the ground state of spinless itinerant bosons on a 1D lattice, subject to periodic boundary conditions, and on-site particle interactions. The Hamiltonian matrix representing the BH model is:
%
\begin{equation}
\label{eq:bh_hamiltonian}
H = - \sum_{ i,j } t_{i,j} b_i^{\dag} b_j + \frac{U}{2} \sum_i n_i (n_i-1) - \sum_i \mu_i n_i
\end{equation}
%
where $t_{i,j}$ is the hopping amplitude between sites $i$ and $j$, $U$ is the on-site interaction strength, $\mu_i$ is an on-site chemical potentials,  $b_i^{\dag}$ $(b_i)$ creates (annihilates) a boson on site $i$, and $n_i$ counts the number of bosons on site $i$. 

In the Fock configuration basis, the interaction potential and the chemical potential terms are diagonal operators, while the first term, the kinetic energy operator, is not. The Hamiltonian can be rewritten as:
%
\begin{equation}
H = H_1 + H_0
\end{equation}
%
where $H_1 = - \sum_{i,j} t_{i,j} b_i^{\dag} b_j$ is the off-diagonal term, while $H_0 = \frac{U}{2} \sum_i n_i (n_i-1) - \sum_i \mu_i n_i$ is the diagonal term.

The matrix elements of the diagonal and the off-diagonal parts of the Hamiltonian can be explicitly determined by sandwiching the operators between basis states. Matrix elements of each of these operators will show up as factors of the partition function. In the next section, explicit expressions for these elements will be derived.

\subsection{Matrix elements}

In this section, the matrix elements of the diagonal and off-diagonal parts of the Bose-Hubbard Hamiltonian will be derived. Additionally, we will introduce a so-called "worm operator". This off-diagonal operator is not traditionally part of the Bose-Hubbard model. Nevertheless, for convenience when implementing the Worm Algorithm, the Hamiltonian will include this term. Thus, matrix elements of the worm operator will also show up as factors of the partition function and will be derived in this section.

\subsubsection{Potential energy and chemical potential}
Due to $H_0$ being a diagonal operator and the basis states being orthonormal, the diagonal matrix elements are rather simply obtained:
%
\begin{equation}
\label{eq:diagonal_elements}
\bra{\alpha^\prime} H_0 \ket{\alpha} =  \bra{\alpha^\prime}  \epsilon_{\alpha} \ket{\alpha}  = \epsilon_{\alpha} \bra{\alpha^\prime} \ket{\alpha} = \epsilon_{\alpha} \delta_{\alpha^\prime,\alpha}
\end{equation}
%
where $\epsilon_{\alpha}$ is the off-diagonal energy of Fock configuration $\alpha$, and $\delta_{\alpha^\prime,\alpha}$ is a Kronecker-Delta function. In other words, the matrix elements vanish when the configurations $\alpha^\prime$ and $\alpha$ are different, and become $\epsilon_{\alpha}$ otherwise.

\subsubsection{Kinetic energy}

The off-diagonal elements of the Hamiltonian are given by:
%
\begin{equation}
\label{eq:bra_H1_ket}
\bra{\alpha^\prime} H_1 \ket{\alpha} = - \sum_{i,j} \bra{\alpha^\prime} t_{i,j} b_i^{\dag} b_j \ket{\alpha}  \equiv H_1^{\alpha^\prime,\alpha}
\end{equation}
%
Recall the definition of the bosonic creation and annihilation operators:
%
\begin{align}
b^\dag \ket{n} &= \sqrt{n+1} \ket{n+1} \\
b \ket{n} &= \sqrt{n} \ket{n-1} 
\end{align}
%
The basis states can be expressed as:
%
\begin{equation}
\ket{\alpha} = \ket{n_1^{\alpha},n_2^{\alpha} \dots , n_L^{\alpha}}
\end{equation}
%
where $n_i^{\alpha} = b_i^\dag b_i$ is the number of particles on site i of the configuration $\ket{\alpha}$, and $L$ is the number of lattice sites. In this representation, acting first with the annihilation operator on site $j$, then acting with the creation operator on site $i$ produces the following result:
%
\begin{equation}
b_i^\dag b_j \ket{n_1^{\alpha},n_2^{\alpha} \dots , n_L^{\alpha   }} = \sqrt{n_j^{\alpha}(n_i^{\alpha}+1)} \ket{\dots , n_j^{\alpha}-1, \dots, n_i^{\alpha}+1, \dots} 
\end{equation}
%
Only sites $i$ and $j$ are modified. The matrix element in Eq.~\eqref{eq:bra_H1_ket} becomes:
%
\begin{equation}
H_1^{\alpha,\alpha} = -\sum_{i,j} t_{i,j} \sqrt{n_j^{\alpha}(n_i^{\alpha}+1)} \bra{n^{\alpha^\prime}_1,n^{\alpha^\prime}_2,\dots,n^{\alpha^\prime}_L} \ket{\dots , n_j^{\alpha}-1, \dots, n_i^{\alpha}+1, \dots} 
\end{equation}
%
Due to orthonormality of the basis states:
%
\begin{equation}
\bra{n^{\alpha^\prime}_1,n^{\alpha^\prime}_2,\dots,n^{\alpha^\prime}_L} \ket{\dots , n_j^{\alpha}-1, \dots, n_i^{\alpha}+1, \dots}  = \delta_{n_i^{\alpha^\prime}, n_i^{\alpha}+1} \delta_{n_j^{\alpha^\prime},n_j^{\alpha}-1} \prod_{k \neq i,j} \delta_{n_k^{\alpha^\prime},n_k^{\alpha}}
\end{equation}
%
where $n^{\alpha}_i$ is the number of particles on site $i$ of the state $\ket{\alpha}$ and the product is carried over all sites $k$, excluding $i$ and $j$. The elements of the kinetic operator then become:
%
\begin{equation}
\label{eq:off_diagonal_elements}
H_1^{\alpha^\prime,\alpha} = -\sum_{i,j} t_{i,j}  \sqrt{n_j^{\alpha}(n_i^{\alpha}+1)} \delta_{n_i^{\alpha^\prime}, n_i^{\alpha}+1} \delta_{n_j^{\alpha^\prime},n_j^{\alpha}-1} \prod_{k \neq i,j} \delta_{n_k^{\alpha^\prime},n_k^{\alpha}}
\end{equation}
%

\subsubsection{Worm operator}

In the next section, it will be discussed in more detail how the partition function can be written as path integrals along the imaginary time direction. These paths, which will be known as worldlines, may have discontinuities along them. Worldline discontinuities will arise due to the insertion of bosonic creation or annihilation operators, which will be known as worm tails and heads, respectively. Here, we will define a "worm operator", related to the insertion or deletion of worm ends. The worm operator is defined as:
%
\begin{equation}
\label{eq:worm_operator}
H_\mathrm{worm} = -\eta \sum_i (b_i^\dag + b_i)
\end{equation}
%
where $\eta$ is a tunable parameter known as the worm fugacity and the sum will be carried over all lattice sites. Sandwiching between Fock states, the matrix elements of the worm operator are obtained:
%
\begin{equation}
\bra{\alpha^\prime} H_\mathrm{worm} \ket{\alpha} \equiv H_\mathrm{worm}^{\alpha^\prime,\alpha} 
\end{equation}
%
In the derivation of the kinetic energy matrix elements $H_1^{\alpha^\prime,\alpha}$ , the Fock states were rewritten explicitly in terms of site occupation numbers as $\ket{\alpha} = \ket{n_1^{\alpha},n_2^{\alpha},\dots,n_L^{\alpha}}$. Rewriting basis states in this way, the matrix elements of the worm operator become:
%
\begin{equation}
\label{eq:worm_elements}
H_\mathrm{worm}^{\alpha^\prime,\alpha} =  -\eta \sum_i  (\sqrt{n_i^{\alpha} + 1} \delta_{n_i^{\alpha^\prime},n_{i}^{\alpha}+1}  + \sqrt{n_i^{\alpha}} \delta_{n_i^{\alpha^\prime},n_{i}^{\alpha}-1}) \prod_{k\neq i} \delta_{n_k^{\alpha^\prime},n_k^{\alpha}} 
\end{equation}
%

Eqs. \eqref{eq:diagonal_elements}, \eqref{eq:off_diagonal_elements}, and \eqref{eq:worm_elements} give the diagonal, off-diagonal, and worm matrix elements of the Bose-Hubbard Hamiltonian \eqref{eq:bh_hamiltonian}. These elements will be necessary in order to sample the partition function of a Bose-Hubbard configuration via Path Integral Monte Carlo. In the next section, the path integral formulation of the partition will be discussed.
 
%-----------------------------   Partition Function (Weights) ----------------------------------------------%
\section{Partition function}

The partition function is defined as:
%
\begin{equation}
\mathcal{Z}  = \Tr \rho \nonumber = \Tr e^{-\beta H} 
\end{equation}
%
where $e^{-\beta H} = \rho$ is the density matrix of the system and $\ket{\psi_T}$ is the trial state. The ground state can be exactly obtained by:
%
\begin{equation}
\ket{\psi_0} = \lim_{\beta\to\infty} e^{-\frac{\beta}{2} H}\ket{\psi_T} 
\end{equation}
%
where $\beta = \frac{1}{k_B  T}$, $H$ is the ground state Hamiltonian, and $\ket{\psi_T}$ is a trial wavefunction. Under this definition, the ground state weight $Z_0$ can then be approximated as the expectation value of the density operator $e^{\beta H}$:
%
\begin{equation}
\label{eq:z_0_01}
\mathcal{Z}_0 = \bra{\psi_0} \hat{I} \ket{\psi_0} = \lim_{\beta\to\infty} \bra{\psi_T} e^{-\beta H} \ket{\psi_T}
\end{equation}
%
To save some typing effort in what follows, define the argument of the limit above as:
%
\begin{equation}
\mathcal{Z}_T \equiv  \bra{\psi_T} e^{-\beta H} \ket{\psi_T}
\end{equation}
%
This "trial weight" $\mathcal{Z}_T$ and hence the ground state weight $\mathcal{Z_0}$ can be sampled via Path Integral Monte Carlo (PIMC). To do this, $\mathcal{Z}_T$ has to be rewritten in the path integral formulation.

\subsubsection{Path integral representation of the partition function}

Due to completeness of the wavefunction, the trial state $\ket{\psi_T}$ can be expanded as:
%
\begin{equation}
\ket{\psi_T} = \sum_{\alpha} C_{\alpha} \ket{\alpha}
\end{equation}
%
where the $C_\alpha$'s are complex expansion coefficients, and the sum is carried over all possible states $\ket{\alpha}$ of a conveniently chosen basis. For the Bose-Hubbard model, the basis that we will "conveniently choose" is the set of all configurations of $N$ particles on a lattice of $L$ sites (i.e, the Fock states). The trial weight becomes:
%
\begin{equation}
\mathcal{Z_T} = \sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*} \bra{\alpha_0} e^{-\beta H} \ket{\alpha_1}
\end{equation}
%
where each of the sums is carried over all Fock states. The state labels could be chosen arbitrarily, but with the power of hindsight, numerical subscripts have been used to distinguish the bra-ket pair, as it will ease the notation in the following steps. Nevertheless, keep in mind that both $\alpha_0$ and $\alpha_1$ will span the space of all Fock configurations, and are not just two basis states of the Hamiltonian.

In the interaction picture of quantum mechanics, the density operator can be expressed as:
%
\begin{equation}
\label{eq:density_op_01}
e^{-\beta H} = e^{-\beta H_0} T_{\tau} e^{- \int_0^{\beta} d\tau_1 [ H_1(\tau_1) + H_\mathrm{worm}(\tau_1) ] }
\end{equation}
where $T_{\tau}$ is the imaginary time-ordering operator and $\tau = it/\hbar$ is the imaginary time. The integrand in the exponent is the interaction picture representation of the off-diagonal part of the Hamiltonian (kinetic and worm operators):
%
\begin{equation}
H_1(\tau_1) = e^{\tau_1 H_0} H_1 e^{-\tau_1 H_0}
\end{equation}
%
%
\begin{equation}
H_\mathrm{worm}(\tau_1) = e^{\tau_1 H_0} H_\mathrm{worm} e^{-\tau_1 H_0}
\end{equation}
%
where the kinetic and worm operators $H_1$ and $H_\mathrm{worm}$, respectively are the off-diagonal parts of the Hamiltonian, and $H_0$ is the diagonal (interaction and chemical potential). The time-ordered exponential can be Taylor expanded as:
\begin{equation}
e^{- \int_0^{\beta} d\tau_1 H_1(\tau_1)} = \mathds{1} - \int_{0}^{\beta} H_1(\tau_1) d\tau_1 + \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 H_1(\tau_1) H_1(\tau_2) - \dots 
\end{equation}
%
Notice that the $H_\mathrm{worm}$ term has been dropped to save some space. It will be inserted at the end of the derivation.

Substituting the Taylor expansion into the trial weight $\mathcal{Z}_T$, it is seen that:
%
\begin{equation}
\begin{aligned}
\mathcal{Z_T} = \sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*} &e^{-\epsilon_{\alpha_0} \beta}  \bra{\alpha_0} ( \\
& \mathds{1} - \int_{0}^{\beta} H_1(\tau_1) d\tau_1 + \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 H_1(\tau_1) H_1(\tau_2) - \dots ) \ket{\alpha_1}
\end{aligned}
\end{equation}
%
where $\epsilon_{\alpha_0}$ is the an eigenvalue of $H_0$, such that $H_0 \ket{\alpha_0} = \epsilon_{\alpha_0} \ket{\alpha_0}$.
By evaluating the first few terms of the Taylor expansion, a generating formula for the trial weight $\mathcal{Z}_T$ can be obtained. 

The zeroth-order term is:
\begin{equation}
\begin{aligned}
\mathcal{Z}_T^{(0)} &= \sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*} e^{-\epsilon_{\alpha_0} \beta}  \bra{\alpha_0} \mathds{1} \ket{\alpha_1} \\
&= \sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*} e^{-\epsilon_{\alpha_0} \beta}  \bra{\alpha_0} \ket{\alpha_1} \\
&= \sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*} e^{-\epsilon_{\alpha_0} \beta} \delta_{\alpha_0,\alpha_1} \\
\mathcal{Z}_T^{(0)}  &= \sum_{\alpha_0} \vert C_{\alpha_0} \vert^2 e^{-\epsilon_{\alpha_0} \beta}
\end{aligned}
\end{equation}

First-order term:
\begin{equation}
\begin{aligned}
\mathcal{Z}_T^{(1)} &= -\sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*}  \int_{0}^{\beta} d\tau_1 e^{-\epsilon_{\alpha_0} \beta} \bra{\alpha_0}  H_1(\tau_1) \ket{\alpha_1} \\
&= -\sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*}  \int_{0}^{\beta} d\tau_1 e^{-\epsilon_{\alpha_0} \beta} \bra{\alpha_0} e^{\tau_1 H_0}H_1e^{-\tau_1 H_0}  \ket{\alpha_1} \\
&= -\sum_{\alpha_0, \alpha_1} C_{\alpha_0} C_{\alpha_1}^{*}  \int_{0}^{\beta} d\tau_1 e^{-\epsilon_{\alpha_0}(\beta-\tau_1)} e^{-\epsilon_{\alpha_1} \tau_1}  \bra{\alpha_0} H_1 \ket{\alpha_1}
\end{aligned}
\end{equation}

%e^{\tau_1 H_0}H_1e^{-\tau_1 H_0} 
%e^{-\epsilon_{\alpha_0}(\beta-\tau_1)} e^{-\epsilon_{\alpha_1}(\tau_1-\tau_2)} e^{-\epsilon_{\alpha_2} \tau_2}

Second-order term:
\begin{equation}
\begin{aligned}
\mathcal{Z}_T^{(2)} &=  \sum_{\alpha_0, \alpha_2} C_{\alpha_0} C_{\alpha_2}^{*} \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 e^{-\epsilon_{\alpha_0} \beta} \bra{\alpha_0}  H_1(\tau_1) H_1(\tau_2) ) \ket{\alpha_2} \\
&= \sum_{\alpha_0, \alpha_1, \alpha_2} C_{\alpha_0} C_{\alpha_2}^{*} \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 e^{-\epsilon_{\alpha_0} \beta} \bra{\alpha_0}  H_1(\tau_1) \ket{\alpha_1} \bra{\alpha_1}   H_1(\tau_2) )  \ket{\alpha_2} \\
\\
&= \sum_{\alpha_0, \alpha_1, \alpha_2} C_{\alpha_0} C_{\alpha_2}^{*} \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 e^{-\epsilon_{\alpha_0} \beta} \bra{\alpha_0}  e^{\tau_1 H_0}H_1e^{-\tau_1 H_0}  \ket{\alpha_1} \bra{\alpha_1} e^{\tau_2 H_0}H_1e^{-\tau_2 H_0}  \ket{\alpha_2} \\
\mathcal{Z}_T^{(2)} &= \sum_{\alpha_0, \alpha_1, \alpha_2} C_{\alpha_0} C_{\alpha_2}^{*} \int_0^{\beta} d\tau_1 \int_{0}^{\tau_1} d\tau_2 e^{-\epsilon_{\alpha_0}(\beta-\tau_1)} e^{-\epsilon_{\alpha_1}(\tau_1-\tau_2)} e^{-\epsilon_{\alpha_2} \tau_2} \bra{\alpha_0} H_1 \ket{\alpha_1} \bra{\alpha_1} H_1 \ket{\alpha_2}
\end{aligned}
\end{equation}

Proceeding in similar fashion, the $Q$-th term of $\mathcal{Z}_T$ becomes:
\begin{equation}
\label{eq:Z^q}
\mathcal{Z}_T^{(Q)} = (-1)^{Q}  \sum_{\alpha_0,\alpha_1,\dots,\alpha_Q} C_{\alpha_0} C_{\alpha_Q}^* e^{-\epsilon_{\alpha_Q} \tau_Q} \prod_{q=0}^Q \int_0^{\tau_{q-1}} d\tau_q e^{-\epsilon_{\alpha_{q-1}}(\tau_{q-1}-\tau_q)} 
\bra{\alpha_{q-1}} H_1 \ket{\alpha_q}
\end{equation}
where $\tau_0 = \beta > \tau_1 > \tau_2 > \dots > \tau_Q = 0$. Summing $Z_T^{(Q)}$ over all $Q$ from $0$ to $\infty$, the full expression for $\mathcal{Z}_T$ is obtained:
%
\begin{equation}
\begin{aligned}
\mathcal{Z}_T = \sum_{Q=0}^{\infty} \mathcal{Z}_T^{(Q)}
\end{aligned}
\end{equation}
%
Recall from Eq.~\eqref{eq:z_0_01} that:
%
\begin{equation}
\mathcal{Z}_0 = \bra{\psi_0} \hat{I} \ket{\psi_0} = \lim_{\beta\to\infty} \bra{\psi_T} e^{-\beta H} \ket{\psi_T} = \lim_{\beta\to\infty} \mathcal{Z}_T
\end{equation}
%
Finally, insert back the $H_\mathrm{worm}$ terms and the weight $\mathcal{Z}_0$ approximately becomes:
%%%%%%%%%%%%%%%%
\begin{equation}
\label{eq:Z_0}
\mathcal{Z}_0 \approx 
\sum_{Q=0}^{\infty} (-1)^{Q}  \sum_{\alpha_0,\alpha_1,\dots,\alpha_Q} C_{\alpha_0} C_{\alpha_Q}^* e^{-\epsilon_{\alpha_Q} \tau_Q} \prod_{q=1}^Q \int_0^{\tau_{q-1}} d\tau_q e^{-\epsilon_{\alpha_{q-1}}(\tau_{q-1}-\tau_q)} 
(H_1^{\alpha_{q-1},\alpha_q} + H_\mathrm{worm}^{\alpha_{q-1},\alpha_q})
\end{equation}
%%%%%%%%%%%%%%%%
where the off-diagonal elements $\bra{\alpha_{q-1}} H_1 \ket{\alpha_q}$ and $\bra{\alpha_{q-1}} H_\mathrm{worm} \ket{\alpha_q}$ are given by Eq.~\eqref{eq:off_diagonal_elements} and Eq.~\eqref{eq:worm_elements}, the diagonal elements $\epsilon_{\alpha}$ are given by Eq.~\eqref{eq:diagonal_elements} and the approximation becomes exact in the limit $\beta\to\infty$.

% -------------- Metropolis Sampling --------------- %
\section{Metropolis sampling}

In this section, a brief walkthrough of the Metropolis-Hastings algorithm \cite{doi:10.1063/1.1699114} will be given. First, the process of obtaining acceptance ratios that satisfy the Principle of Detailed Balance will be given. Then, the Metropolis-Hastings algorithm will be stated.

\subsection{Deriving Metropolis acceptance ratios}

The Principle of Detailed Balance states that in an equilibrium system, the number of transitions from a configuration $x$ to a configuration $x'$, must be equal to the number of transitions from $x'$ to $x$. This principle can be expressed as:
%
\begin{equation}
\label{eq:detailed_balance_principle}
p(x)P(x \to x') = p(x') P(x' \to x)
\end{equation}
%
where $p(x)$ is the steady state probability distribution, and $P(x \to x')$ is the probability of transitioning to $x'$ conditional to original state $x$. Solving for the ratio of transition probabilities:
%
\begin{equation}
\label{eq:transition_ratio}
\frac{P(x \to x')}{P(x' \to x)} = \frac{p(x')}{p(x)} 
\end{equation}
%
The transition probability can rewritten as a factor of proposal and acceptance probabilities:
%
\begin{equation}
P(x \to x') = g(x \to x') A(x \to x')
\end{equation}
%
where $g(x \to x')$ is the probability of proposing an update that takes the state of the system from $x$ to $x'$, and $A(x \to x')$ is the probability of accepting such update. Substituting the factored transition probabilities into Eq.~\eqref{eq:transition_ratio}:
%
\begin{equation}
\frac{g(x \to x') A(x \to x')}{ g(x' \to x) A(x' \to x)} = \frac{p(x')}{p(x)} 
\end{equation}
%
The ratio of acceptance probabilities becomes:
%
\begin{equation}
\label{eq:acceptance_ratio}
\frac{A(x \to x')}{A(x' \to x)} = \frac{p(x')g(x' \to x)}{p(x) g(x \to x')} \equiv R
\end{equation}
%
Depending on the value of $R$, there are various ways in which the acceptance probabilities can be chosen, such that they satisfy Eq.~\eqref{eq:acceptance_ratio}.

If $R \leq 1$:
%
\begin{equation} 
A(x \to x' ) = R \text{ and } A(x' \to x) = 1 \nonumber
\end{equation}
%

If $R > 1$: 
\begin{equation}
A(x \to x' ) = 1 \text{ and } A(x' \to x) = 1/R \nonumber
\end{equation}

The above selections can be summarized as:
%
\begin{equation}
\label{eq:general_acceptance_probs}
A(x \to x') = min\{1,R\} \text{ and } A(x' \to x) = min\{1,1/R\}
\end{equation}
%

As part of Metropolis sampling, proposed configurations will be accepted with the probabilities in Eq.~\eqref{eq:general_acceptance_probs}.

\subsection{The Metropolis-Hastings algorithm}

Essentialy, Eq.~\eqref{eq:sexytime} is an approximation. In the incredible paper by Prokokkokokok \cite{Prokof_ev_1998}, the authors play some Pokemon. In the Metropolis paper \cite{doi:10.1063/1.1699114}. On the Brian Keng's website \cite{bkeng.metropolis}

\section{Lattice Worm Algorithm (WA) Updates}

In this section, a set of ergodic lattice worm updates is introduced. First, an explanation of how each update changes the system is given.. Then, a walkthrough of the decisions that comprise each update will be given, including the probabilities for each desicion's outcome. Finally, the Metropolis conditions are derived or the direct sampling explained, depending on the update.

	\subsection{Insert/Delete worm}
        
    The insert worm update creates a particle on a flat region of a worldline, then destroys it after a certain time, also inside the same flat region. Formally, the particle is created by acting on the state at that imaginary time with the bosonic creation operator (worm tail) and anihilated by acting with the bosonic anihilation operator (worm head). An antiworm can instead be inserted by first inserting the worm head and then the tail. In other words, an antiworm will first anihilate a particle and create one at a later time inside the flat region. The update proceeds as follows:
%
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{iw}$
        \item Randomly choose an integer $i \in [0,L-1]$, where $L$ is the number of sites on the lattice. The $i^{th}$ site will be chosen wih probability $p_i = 1/L$.
        \item Randomly choose an integer $f \in [0,F - 1]$, where $F$ is the number of flat regions on site $i$. The $f^{th}$ flat region will be chosen with probability $p_{f} = 1/F$
        \item Count the number of particles $n_{flat}$ on the flat region and check if inserting an antiworm is possible:
            \begin{enumerate}
            \item If $n_{flat} = 0$ : Only a worm can be inserted with probability $p_{type} = 1$
            \item Else: A worm or antiworm can be inserted with probability $p_{type} = 1/2$
            \end{enumerate}
        \item Randomly choose a real number $\Delta\tau_{worm} = rand()*\Delta\tau_{flat}$, where $\Delta\tau_{flat}$ is the length of the flat region and $rand()$ is a random number from the uniform distribution in the interval $[0,1)$. The probability of the worm being of length $\Delta\tau_{worm}$ is $p_{len} = 1/{\Delta\tau_{flat}}$
        \item Randomly select a real number $\tau = \tau_{min} + rand()*(\Delta\tau_{flat}-\Delta\tau_{worm})$, where $\tau_{min}$ is the lower bound of the flat region. The probability of inserting the worm (antiworm) tail (head) at $\tau$ is $p_{\tau} = 1/(\Delta\tau_{flat} - \Delta\tau_{worm})$.
        \item Calculate the ratio of weights of configurations pre and post worm insertion:
            %
            \begin{equation}
            \frac{W_+}{W_-} = \eta^2 e^{-\Delta\tau_{worm} \Delta V}
            \label{eq:insert_ratios}
            \end{equation}
            %
            where $W_+$ and $W_-$ are the weights of the configuration with a worm and no worm, respectively, $\eta$ is the worm fugacity and $\Delta V$ is the change in potential energy pre and post worm insertion. 
    \end{enumerate}
    %

    \subsection{Insert/Delete ground state (gs) worm}
    These updates will be very similar to the insert/delete worm update. The main difference is that these are particular to the case of zero temperature. Remember that at zero temperature, imaginary time is not subject to periodic boundary conditions, as is the case at finite temperature. Instead, open boundary conditions are imposed in the imaginary time direction, while keeping the space direction periodic. 

    The open boundary conditions will allow now for the insertion of worms that will have one of its ends go past either the $\tau = 0$ or the $\tau = \beta$ boundaries. These worms that go past the imaginary time boundaries will be called ground state (gs) worms. In practice, inserting a gs-worm will look like inserting only one worm end to the worldline configuration at a time, and analogously for deletion. 

    \subsubsection{Insert gs-worm}

    At $T=0$, a ground state (gs) worm or antiworm can be inserted. One of the ends of this worm will lie either past the $\tau=0$ or the $\tau=\beta$ boundaries. The other end, will lie in the flat region preceding this boundary (i.e, the first or the last flat region). In practice, this will look like inserting a single worm end to the worldline configuration at these flat regions. This worm end can only be inserted if there are no worm ends or one worm end present. The update proceeds as
    follows:
    % Insert gs-worm %
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{gsiw}$
    \item Choose site with probability $p=1/L$
    \item Choose first or last flat:
        \begin{enumerate}
            \item if $n_{flats} = 1$: treat the flat as first or last (depending on the implementation) with $p=1$
            \item else: $p=1/2$
        \end{enumerate}
    \item Choose gs-worm or gs-antiworm:
        if $n_i=0$: can only insert worm with prob. $p=1$ 
        else: choose either with $p=1/2$
    \item Choose the insertion time of the worm end $\tau = \tau_{min} + rand() (\tau_{max}-\tau_{min})$ with probability $p=1/(\tau_{max}-\tau_{min})$
    \end{enumerate}

    \subsubsection{Delete gs-worm}
    The Delete gs-worm update can only be done if there's at least one worm end on the worldline configuration. A random worm end is chosen and then deleted. The update proceeds as follows:
    % Delete gs-worm %
    \begin{enumerate}
        \setcounter{enumi}{-1}
    \item Do with probability $p_{gsdw}$
    \item Choose the worm end to be deleted with probability $p=1/2$
    \end{enumerate}

    \subsubsection{Acceptance probabilities of gs-worm insert/delete}

    From detailed balance:
    %
    \begin{equation}
        w_- p_{gsiw}^{att} p_{gsiw}^{acc} = W_+ p_{gsdw}^{att} p_{gsdw}^{acc}
    \end{equation}
    %

    Solving for the ratio of acceptance probabilities:
    %
    \begin{equation}
        \frac{p_{gsiw}^{acc}}{p_{gsdw}^{acc}} = \frac{p_{gsdw}^{att} W_+}{p_{gsiw}^{att} W_-}  
    \end{equation}
    %

    Inserting the attempt probabilities:
    %
    \begin{equation}
        \frac{p_{gsiw}^{att}}{p_{gsdw}^{att}} = \frac{p_{gsdw}^{att}}{p_{gsiw}^{att}} \frac{L(\tau_{max}-\tau_{min})}{p_{flat}} \frac{W_+}{W-}
    \end{equation}
    %

    where $p_{flat}$ is the probability of choosing either the first or last flat region of the worldline. If there are no kinks in the worldline, $p_{flat}=1$, and if there are kinks, $p_{flat=1/2}$.


    The ratio of weights for configurations after a gs-worm insertion and after it is deleted is:
    %
    \begin{equation}
        \frac{W_+}{W_-} = \eta e^{-\Delta \tau \Delta V}
    \end{equation}
    %

	\subsection{Timeshift}

	\subsection{Summary of weight ratios}
	
		
    \begin{enumerate}
        \setcounter{enumi}{0}
    \item Insert:  $\frac{W^\prime}{W}= \eta^2 n_i^{\alpha_w} e^{-(\epsilon_w-\epsilon)(\tau_h-\tau_t)}$
    \item Delete: $\frac{W^\prime}{W}= 1/(\eta^2 n_i^{\alpha_w} e^{-(\epsilon_w-\epsilon)(\tau_h-\tau_t)})$
    \item Timeshift
    	\begin{enumerate}
	\item{Shift head: $\frac{W^\prime}{W}=e^{-(\epsilon_w-\epsilon)(\tau_h^\prime-\tau_h)}$}
	\item{Shift tail: $\frac{W^\prime}{W}=e^{-(\epsilon_w-\epsilon)(\tau_t-\tau_t^\prime)}$}
	\end{enumerate}
    \item Insert from $\tau=0$
    	\begin{enumerate}
	\item{Worm: $\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)\tau_h}$ }
	\item{Antiworm:$\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha}}{C_{\alpha_w}}e^{-(\epsilon_w-\epsilon)(-\tau_t)}$ }
	\end{enumerate}
    \item Insert from $\tau=\beta$
    	\begin{enumerate}
	\item{Worm: $\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)(\beta-\tau_t)}$}
	\item{Antiworm: $\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)(\tau_h - \beta)}$}
	\end{enumerate}
    \item Delete from $\tau=0$
    	\begin{enumerate}
	\item{Worm: $\frac{W^\prime}{W}= 1/(\eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)\tau_h})$}
	\item{Antiworm: $\frac{W^\prime}{W}= 1/(\eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha}}{C_{\alpha_w}}e^{-(\epsilon_w-\epsilon)(-\tau_t)}) $}
	\end{enumerate}
    \item Delete from $\tau=\beta$
    	\begin{enumerate}
	\item{Worm: $1/(\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)(\beta-\tau_t)})$}
	\item{Antiworm: $1/(\frac{W^\prime}{W}= \eta \sqrt{n_i^{\alpha_w}} \frac{C_{\alpha_w}}{C_{\alpha}}e^{-(\epsilon_w-\epsilon)(\tau_t - \beta)})$}
	\end{enumerate}
    \end{enumerate}


	
% References
\phantomsection 
\addcontentsline{toc}{chapter}{References} 
%\bibliographystyle{apalike} %acm, ieetr, apalike...
 %\section*{Referencess
 \singlespacing
\bibliography{references}

\doublespacing

\end{document}
